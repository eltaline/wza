<img src="/images/logo.png" alt="wZA Logo"/>

wZA это архиватор написанный на языке Go, использующий <a href=https://github.com/eltaline/bolt>модифицированную</a> версию BoltDB баз,
созданный для конвертации обычных файлов в Bolt архивы и их распаковки. Архиватор используется
совместно с <a href=https://github.com/eltaline/wzd>wZD</a> сервером.

- Схема применения wZD сервера:

<img src="/images/wzd-scheme.png" alt="wZD Scheme"/>

Текущая стабильная версия: 1.2.0
========

- <a href=/CHANGELOG-RUS.md>Changelog</a>

Добавлено в версии 1.2.0:

- Параметры (--skeyscnt, --smaxsize), для автоматического шардинга Bolt архивов в каждой директории
- Изменена лицензия проекта на Apache 2.0 лицензию

Исправлено в версии 1.2.0:

- Незначительные исправления ошибок

Возможности
========

- Многопоточность
- Архивирование файлов размером до 32 MB
- Поддержка CRC целостности данных при записи/чтении
- Поддержка смешанного режима. Большие файлы могут исключаться из архивации в Bolt архивы

Несовместимости
========

- Пока не поддерживается повторный подсчет и запись контрольной суммы без операций распаковки и упаковки
- Нельзя просто так взять и перенести диски с данными из Little Endian системы в Big Endian систему и наоборот

Требования
========

- Операционные системы: 64 Bit Linux/BSD/Solaris/OSX
- Архитектуры: amd64/arm64/ppc64/mips64, проверялась только amd64
- Поддерживаемый порядок байт Little/Big Endian
- Любая POSIX совместимая файловая система с полноценной поддержкой блокировок (предпочтительна кластерная MooseFS)

Реальное применение
========

Наш кластер имеет порядка 250 000 000 маленьких картинок и 15 000 000 директорий на раздельных SATA дисках.
Используемая кластерная файловая система MooseFS. Она неплохо работает с таким количеством файлов,
но при этом ее Master серверы потребляют по 75 гигабайт оперативной памяти, и так как происходят частые дампы
большого количества метаданных, то это плохо сказывается на SSD дисках. Еще соответственно есть ограничение примерно
в 1 миллиард файлов в самой MooseFS при 1-ой реплике каждого файла.

В среднем у нас в разрозненной структуре директорий, где хранятся от 10 до 1000 файлов в большинстве директорий, после установки wZD и архивирования файлов в Bolt архивы, у нас получилось примерно в 25 раз меньше файлов, около 10 000 000. При правильном планировании структуры директорий можно было бы добиться и меньшего количества файлов, но какая структура уже была, такая пока и осталась. Этим мы добились очень большой экономии inodes, низкого потребления памяти кластерной ФС, значительного ускорения работы самой MooseFS, и сокращения реально занимаемого места на кластерной ФС MooseFS. Дело в том, что MooseFS выделяет под каждый файл блок всегда размером 64KB, то есть если у вас файл имеет размер 3KB, то выделено все равно будет 64KB.

Многопоточный wZA архиватор уже протестирован на реальных данных.

Наш кластер(10 серверов) это Origin сервер, установленный за CDN сетью и обслуживаемый всего 2-мя wZD серверами.

<p align="center">
<img align="center" src="/images/reduction-full.png"/>
</p>

Документация
========

<b>Таблица, описывающая наиболее оптимальные варианты использования архиватора. Сколько файлов можно загрузить в один Bolt архив.</b>

<p align="center">
<img align="center" src="/images/optimal.png"/>
</p>

Установка
--------

Установка пакетов/бинарников
--------

- <a href=https://github.com/eltaline/wza/releases>Скачать</a>

**Файлы упаковываются и распаковываются в той же директории где они и находились, а не в текущей откуда запускается wZA**

Просмотр содержимого Bolt архива
--------

```bash
wza --show=/path/to/file.bolt
```

Упаковка одиночного файла в Bolt архив
--------

```bash
wza --pack --single=/path/to/file.ext
```

Распаковка всех файлов из одиночного Bolt архива
--------

```bash
wza --unpack --single=/path/to/file.bolt
```

Упаковка всех файлов по списку в Bolt архивы
--------

```bash
find /var/storage -type f -not -name '*.bolt' > /tmp/pack.list
wza --pack --list=/tmp/pack.list
```

Распаковка всех файлов из списка Bolt архивов
--------

```bash
find /var/storage -type f -name '*.bolt' > /tmp/unpack.list
wza --unpack --list=/tmp/unpack.list
```

Миграция данных в 3 шага без остановки сервиса.
--------

Данный архиватор был разработан с целью использования совместно с <a href=https://github.com/eltaline/wzd>wZD</a> сервером,
для конвертации файлов на текущих реальных продакшн системах без остановки сервиса.

Архиватор позволяет без удаления, с удалением, сконвертировать текущие файлы в Bolt архивы, и так же распаковать обратно. Поддерживает перезапись и другие функции.

**Архиватор, насколько это возможно, максимально безопасен, не поддерживает рекурсивного обхода, только работу по заранее подготовленному списку файлов или Bolt архивов, обеспечивает повторное считывание файла после упаковки и проверку CRC контрольной суммы на лету.**

Руководство по миграции данных:

Путь, который подлежит миграции: /var/storage , здесь лежат jpg файлы в 1-м миллионе поддиректорий различной глубины, которые надо упаковать в Bolt архивы, но только те которые размером не больше 1 МБ.

- У вас должен уже быть настроен nginx/haproxy и wZD сервер с виртуальным хостом на директорию /var/storage

- Выполнить рекурсивный поиск
  ```bash
  find /var/storage -type f -name '*.jpg' -not -name '*.bolt' > /tmp/migration.list
  ```
- Запустить архивацию без удаления текущих файлов
  ```bash
  wza --pack --fmaxsize=1048576 --list=/tmp/migration.list
  ```
- Запустить удаление старых файлов с проверкой ключей в Bolt архивах, без удаления файлов, которые размером больше чем fmaxsize
  ```bash
  wza --pack --delete --fmaxsize=1048576 --list=/tmp/migration.list
  ```

Можно совместить в одну операцию, сразу с удалением старых файлов.
Архиватор пропускает не регулярные файлы и не позволит заархивировать Bolt архив в Bolt архив.
Архиватор не удалит файл пока контрольная сумма считываемого файла не совпадет после архивации с вновь считанным файлом из Bolt архива, если это конечно принудительно не отключить.
Пока работает wZD сервер, он отдает данные из обычных файлов, если находит их. Это приоритетно.

В данном руководстве приведен пример с однопоточным запуском, остановкой при любой ошибке с любым файлом, в том числе если в заранее подготовленный список попали не регулярные файлы или же файлы вдруг были удалены другим процессом, а в списке они остались. Для игнорирования уже несуществующих в реальности файлов из списка требуется добавить параметр --ignore-not. То же верно и при распаковке.

Повторный запуск архивации без параметра --overwrite не перезапишет файлы в Bolt архивах. То же верно и при распаковке.

Архиватор поддерживает и многопоточный вариант --threads= и так же другие опции.
В многопоточном варианте автоматически применяется параметр --ignore, чтобы не останавливать работающие потоки при возникновении любых ошибок. При ошибке и включенном --delete параметре, исходный файл не удалится.

Полное описание всех параметров продукта доступно здесь: <a href="/OPTIONS-RUS.md">Опции</a>

Примечания и Q&A
========

- Bolt архивы именуются автоматически по названию директории в которой они создаются

- Не рекомендуется загружать 100000+ файлов в один архив, это будет оверхед

- Не рекомендуется загружать в Bolt архивы файлы/значения размером больше 16МБ. По умолчанию параметр fmaxsize = 1048576 байт

- При превышении параметра fmaxsize, файлы пропускаются. Максимально возможный размер параметра fmaxsize = 33554432 байт

- При использовании параметров --disablewriteintegrity и/или --disablereadintegrity , CRC контрольная сумма не записывается и не проверяется. Настоятельно рекомендуется не использовать данные параметры

ТуДу
========

- Сделать повторный подсчет и запись контрольной суммы без операций распаковки и упаковки
- Сделать проверку CRC для содержимого одного архива
- Добавить компрессию (gzip, zstd, snappy)
- Добавить шифрование

Параметры
========

Полное описание всех параметров продукта доступно здесь: <a href="/OPTIONS-RUS.md">Опции</a>

Гарантии
========

Никакие гарантии на данное программное обеспечение не предоставляются. Просьба сначала тестировать.

Пожертвования
========

<a href="https://www.paypal.me/xwzd"><img src="/images/paypal.png"><a/>

Контакты
========

- E-Mail: dev@wzd.dev
- Сайт wZD: https://wzd.dev
- Сайт компании: <a href="https://elta.ee">Eltaline</a>

```
Copyright © 2020 Andrey Kuvshinov. Contacts: <syslinux@protonmail.com>
Copyright © 2020 Eltaline OU. Contacts: <eltaline.ou@gmail.com>
All rights reserved.
```
